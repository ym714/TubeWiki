---
marp: true
theme: default
paginate: true
header: FlashNote AI - 環境変数構成の解説
footer: 2025-12-03 | Architecture Documentation
---

# なぜ `.env` ファイルが2つあるのか？

**CoreサービスとWorkerサービスの分離について**

---

## 1. アーキテクチャの概要

FlashNote AIは **マイクロサービス（に近い）アーキテクチャ** を採用しています。
機能ごとに独立した2つのアプリケーションとして構成されています。

1.  **Core Service (`core/`)**:
    - ユーザーからのリクエストを受け付ける **Web API**。
    - 役割: 認証、データの保存(DB)、ジョブの受付。
2.  **Worker Service (`worker/`)**:
    - 重たい処理を裏側で行う **バックグラウンドワーカー**。
    - 役割: YouTube字幕取得、AI生成(Groq)、Notion連携。

---

## 2. それぞれの `.env` の役割

独立して動くため、必要な「鍵（環境変数）」も異なります。

### `core/.env` (APIサーバー用)
ユーザーと話すために必要な設定です。
- **`SUPABASE_JWT_SECRET`**: ユーザーのログイン状態（トークン）を検証するため。
- **`QSTASH_TOKEN`**: ジョブをQStash（メッセージキュー）に **送信** するため。
- **`DATABASE_URL`**: ユーザー情報やノートの状態をDBに書き込むため。

### `worker/.env` (作業員用)
作業を実行するために必要な設定です。
- **`GROQ_API_KEY`**: AI (Llama 3.3) を動かすため。
- **`NOTION_TOKEN`**: Notionに書き込むため。
- **`QSTASH_CURRENT_SIGNING_KEY`**: QStashから来た依頼が本物か **検証** するため。

---

## 3. なぜファイルを分けるのか？ (メリット)

1.  **セキュリティ (最小権限の原則)**:
    - `Core` は AIのキーを知る必要がなく、`Worker` は ユーザー認証の秘密鍵を知る必要がありません。
    - 万が一どちらかが侵害されても、被害を最小限に抑えられます。
2.  **独立したデプロイ**:
    - 将来的に `Core` は Vercel、`Worker` は Railway や Cloud Run など、別の場所にデプロイする可能性があります。
    - その際、それぞれの環境変数を個別に設定する必要があります。
3.  **開発の明確化**:
    - どのサービスがどの外部サービスに依存しているかが明確になります。

---

## 4. 共通する設定 (`DATABASE_URL`)

唯一、**`DATABASE_URL`** だけは両方で必要です。

- **Core**: 「処理待ち (PENDING)」のノートを作成するため。
- **Worker**: 処理が終わったら「完了 (COMPLETED)」に更新するため。

**注意点**:
ローカル開発では、両方の `.env` の `DATABASE_URL` を **同じ Supabase (PostgreSQL) のURL** に設定する必要があります。
(現在は `core` が SQLite になっているので、修正が必要です)

---

## 5. まとめ

- **2つの `.env` がある理由**: `Core` と `Worker` が別のアプリケーションとして独立して動いているから。
- **Core**: 受付係（認証、依頼の受付）。
- **Worker**: 職人（AI生成、Notion作成）。
- **共通**: データベース（仕事の台帳）は共有する。

それぞれの役割に必要な「道具（環境変数）」だけを持たせることで、安全かつ整理された構成になっています。
