============================= test session starts ==============================
platform darwin -- Python 3.14.0, pytest-9.0.1, pluggy-1.6.0 -- /usr/local/bin/python3
cachedir: .pytest_cache
rootdir: /Users/motoki/projects/TubeWiki
configfile: pytest.ini
plugins: mock-3.15.1, anyio-4.11.0, asyncio-1.3.0, cov-7.0.0
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 5 items

tests/core/test_api.py::test_health_check PASSED                         [ 20%]
tests/core/test_api.py::test_create_note FAILED                          [ 40%]
tests/core/test_api.py::test_create_note_invalid_url FAILED              [ 60%]
tests/core/test_api.py::test_get_note PASSED                             [ 80%]
tests/core/test_api.py::test_get_note_not_found PASSED                   [100%]

=================================== FAILURES ===================================
_______________________________ test_create_note _______________________________

client = <httpx.AsyncClient object at 0x121102990>
session = <sqlalchemy.orm.session.AsyncSession object at 0x120f67770>

    @pytest.mark.asyncio
    async def test_create_note(client: AsyncClient, session: AsyncSession):
        # Override auth
        app.dependency_overrides[get_current_user] = lambda: "test_user_id"
    
        try:
            # Test creating a new note
            response = await client.post(
                "/api/v1/notes",
                json={"video_url": "https://www.youtube.com/watch?v=dQw4w9WgXcQ", "user_id": "test_user_id"}
            )
>           assert response.status_code == 202
E           assert 500 == 202
E            +  where 500 = <Response [500 Internal Server Error]>.status_code

tests/core/test_api.py:25: AssertionError
----------------------------- Captured stdout call -----------------------------
2025-12-03 04:33:54 - core.middleware.logging - [32mINFO[0m - Request started
2025-12-03 04:33:56 - core.middleware.logging - [32mINFO[0m - Request completed
------------------------------ Captured log call -------------------------------
INFO     core.middleware.logging:logging.py:21 Request started
ERROR    core.services.qstash:qstash.py:29 Failed to publish job to QStash: Client error '410 Gone' for url 'https://qstash.upstash.io/v1/publish/http://localhost:8001'
For more information check: https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/410
ERROR    core.api.notes:notes.py:41 Failed to publish job: Client error '410 Gone' for url 'https://qstash.upstash.io/v1/publish/http://localhost:8001'
For more information check: https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/410
INFO     core.middleware.logging:logging.py:41 Request completed
_________________________ test_create_note_invalid_url _________________________

client = <httpx.AsyncClient object at 0x121181a70>

    @pytest.mark.asyncio
    async def test_create_note_invalid_url(client: AsyncClient):
        app.dependency_overrides[get_current_user] = lambda: "test_user_id"
        try:
            response = await client.post(
                "/api/v1/notes",
                json={"video_url": "invalid-url", "user_id": "test_user_id"}
            )
>           assert response.status_code == 422 # Validation error
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E           assert 500 == 422
E            +  where 500 = <Response [500 Internal Server Error]>.status_code

tests/core/test_api.py:46: AssertionError
----------------------------- Captured stdout call -----------------------------
2025-12-03 04:33:56 - core.middleware.logging - [32mINFO[0m - Request started
2025-12-03 04:33:56 - core.middleware.logging - [32mINFO[0m - Request completed
------------------------------ Captured log call -------------------------------
INFO     core.middleware.logging:logging.py:21 Request started
ERROR    core.services.qstash:qstash.py:29 Failed to publish job to QStash: Event loop is closed
ERROR    core.api.notes:notes.py:41 Failed to publish job: Event loop is closed
INFO     core.middleware.logging:logging.py:41 Request completed
=============================== warnings summary ===============================
../../../../Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/fastapi/routing.py:233: 12 warnings
  /Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/fastapi/routing.py:233: DeprecationWarning: 'asyncio.iscoroutinefunction' is deprecated and slated for removal in Python 3.16; use inspect.iscoroutinefunction() instead
    is_coroutine = asyncio.iscoroutinefunction(dependant.call)

core/main.py:67
  /Users/motoki/projects/TubeWiki/core/main.py:67: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    @app.on_event("startup")

../../../../Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/fastapi/applications.py:4495
../../../../Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/fastapi/applications.py:4495
  /Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/fastapi/applications.py:4495: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    return self.router.on_event(event_type)

core/main.py:73
  /Users/motoki/projects/TubeWiki/core/main.py:73: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    @app.on_event("shutdown")

tests/core/test_api.py::test_create_note
tests/core/test_api.py::test_create_note
tests/core/test_api.py::test_create_note_invalid_url
tests/core/test_api.py::test_create_note_invalid_url
tests/core/test_api.py::test_get_note
tests/core/test_api.py::test_get_note
  /Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/pydantic/fields.py:747: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    return fac()

tests/core/test_api.py::test_create_note
tests/core/test_api.py::test_create_note_invalid_url
  /Users/motoki/projects/TubeWiki/core/services/qstash.py:20: PydanticDeprecatedSince20: The `dict` method is deprecated; use `model_dump` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    json=job.dict(),

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
================================ tests coverage ================================
_______________ coverage: platform darwin, python 3.14.0-final-0 _______________

Name                               Stmts   Miss  Cover   Missing
----------------------------------------------------------------
core/__init__.py                       0      0   100%
core/api/notes.py                     45      9    80%   48, 62, 72-80
core/api/payment.py                   44     30    32%   19-39, 43-66
core/config.py                        27     12    56%   15-26
core/main.py                          30      4    87%   60, 69-70, 75
core/middleware/__init__.py            3      0   100%
core/middleware/error_handler.py      29     16    45%   27-115
core/middleware/logging.py            20      4    80%   57-72
core/middleware/rate_limit.py         11      2    82%   25-35
core/services/auth.py                 20     12    40%   14-36
core/services/qstash.py               18      1    94%   27
core/services/stripe_service.py       14      7    50%   8-29, 32
shared/__init__.py                     0      0   100%
shared/db.py                          19      7    63%   17-18, 28-30, 33-37
shared/db_init.py                      5      5     0%   1-6
shared/models/__init__.py              0      0   100%
shared/models/note.py                 20      0   100%
shared/models/user.py                  9      0   100%
shared/schemas/__init__.py             0      0   100%
shared/schemas/job.py                  5      0   100%
shared/utils/__init__.py               0      0   100%
shared/utils/exceptions.py            64     27    58%   10-13, 21, 28, 36-37, 44-45, 53, 60-61, 69-70, 77, 84, 91, 98, 106, 113-114, 121, 129-130, 138, 145
shared/utils/logger.py                48     19    60%   54, 66, 76-83, 90-91, 96, 101-108, 119-121
shared/utils/retry.py                 49     49     0%   3-155
shared/utils/validators.py            55     55     0%   3-181
tests/conftest.py                     42      3    93%   24-26
tests/core/test_api.py                54      7    87%   26-34
----------------------------------------------------------------
TOTAL                                631    269    57%
=========================== short test summary info ============================
FAILED tests/core/test_api.py::test_create_note - assert 500 == 202
FAILED tests/core/test_api.py::test_create_note_invalid_url - assert 500 == 422
=================== 2 failed, 3 passed, 24 warnings in 2.52s ===================
